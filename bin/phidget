#!/usr/bin/env ruby

require 'rubygems'
require 'phidgets'

def usage
  $stdout.puts 'phidget [[host:]id] cmd [args]'
  $stdout.puts '    host  = host name if connecting through web service'
  $stdout.puts '    id    = serial # of phidget board (-1 for any)'
  $stdout.puts '    cmd   = list | method'
  $stdout.puts '    args  = arguments are dependent on the command'
  $stdout.puts
  $stdout.puts '  Examples:'
  $stdout.puts '    phidget list'
  $stdout.puts '    phidget -1 setOutputState 0 1'
  $stdout.puts '    phidget 34619 getDeviceName'
end

begin
  list = false
  host = nil
  id = nil

  case ARGV[0]
  when /^(-1|\d+)$/
    id = $1.to_i
  when /^(\w|.+):(-1|\d+)$/
    host = $1
    id = $2.to_i
  when /^list$/i
    list = true
  when /^(\w|.+)$/
    if ARGV[1].downcase == 'list'
      list = true
      host = $1
    else
      raise "Invalid Arguments."
    end
  else
    raise "Invalid Arguments."
  end

  manager = Phidgets::Manager.new

  if host
    manager.openRemoteIP(host)
  else
    manager.open
  end

  devices = manager.getAttachedDevices
  manager.close

  if devices.size == 0
    $stdout.puts "\nThere are no phidgets attached.\n"
    exit
  end

  if list
    $stdout.puts "\n----------------------------------------------------------------------"
    $stdout.puts "| SerialNumber          | Device Name                                |"
    $stdout.puts "----------------------------------------------------------------------"
    devices.each_pair { |serial,phidget|
      d_str = "| #{serial}"
      d_str += " " * (24 - d_str.length) + "| #{phidget.getDeviceName}"
      d_str += " " * (69 - d_str.length) + "|"
      $stdout.puts d_str
    }
    $stdout.puts "----------------------------------------------------------------------\n"
  
  else
    phidget = id==-1 ? devices.values[0] : devices[id]
    $stdout.puts eval("phidget.#{ARGV[1]}(#{ARGV[2..-1].join(',')})")
  end

rescue SystemExit
rescue Exception => e
  $stdout.puts "#{e}\n#{e.backtrace.join("\n")}\n#{usage}\n"
end

